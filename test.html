<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Save Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-6">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl font-bold mb-6">GitHub Save Test</h1>
        
        <!-- Configuration -->
        <div class="bg-white p-4 rounded border mb-4">
            <h2 class="text-lg font-medium mb-3">GitHub Configuration</h2>
            <div class="grid grid-cols-2 gap-4">
                <input type="password" id="token" placeholder="GitHub Token" class="p-2 border rounded">
                <input type="text" id="owner" placeholder="Owner" class="p-2 border rounded">
                <input type="text" id="repo" placeholder="Repository" class="p-2 border rounded">
                <input type="text" id="filename" placeholder="Filename" value="test-data.json" class="p-2 border rounded">
            </div>
            <button id="save-config" class="mt-3 px-4 py-2 bg-blue-600 text-white rounded">Save Config</button>
        </div>

        <!-- Test Data -->
        <div class="bg-white p-4 rounded border mb-4">
            <h2 class="text-lg font-medium mb-3">Test Data</h2>
            <textarea id="test-data" rows="6" class="w-full p-2 border rounded">{
  "message": "Hello from test",
  "timestamp": "2024-10-24T12:00:00Z",
  "counter": 1
}</textarea>
            <div class="mt-3 space-x-2">
                <button id="save-to-github" class="px-4 py-2 bg-green-600 text-white rounded">Save to GitHub</button>
                <button id="load-from-github" class="px-4 py-2 bg-blue-600 text-white rounded">Load from GitHub</button>
                <button id="increment-test" class="px-4 py-2 bg-purple-600 text-white rounded">Increment & Save</button>
            </div>
        </div>

        <!-- Status -->
        <div class="bg-white p-4 rounded border">
            <h2 class="text-lg font-medium mb-3">Status & Logs</h2>
            <div id="status" class="mb-3 text-sm"></div>
            <div id="logs" class="bg-gray-100 p-3 rounded text-xs font-mono h-40 overflow-y-auto"></div>
        </div>
    </div>

    <script>
        let config = {
            token: '',
            owner: '',
            repo: '',
            filename: 'test-data.json',
            branch: 'main'
        };

        function log(message) {
            console.log(message);
            const logs = document.getElementById('logs');
            logs.innerHTML += new Date().toLocaleTimeString() + ': ' + message + '\n';
            logs.scrollTop = logs.scrollHeight;
        }

        function setStatus(message, isError = false) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = isError ? 'text-red-600' : 'text-green-600';
        }

        document.getElementById('save-config').addEventListener('click', () => {
            config.token = document.getElementById('token').value;
            config.owner = document.getElementById('owner').value;
            config.repo = document.getElementById('repo').value;
            config.filename = document.getElementById('filename').value;
            
            localStorage.setItem('github-test-config', JSON.stringify(config));
            log('Configuration saved locally');
            setStatus('Configuration saved');
        });

        document.getElementById('save-to-github').addEventListener('click', async () => {
            const data = document.getElementById('test-data').value;
            try {
                const result = JSON.parse(data);
                await saveToGitHub(result);
            } catch (error) {
                log('ERROR: Invalid JSON data');
                setStatus('Invalid JSON data', true);
            }
        });

        document.getElementById('load-from-github').addEventListener('click', async () => {
            await loadFromGitHub();
        });

        document.getElementById('increment-test').addEventListener('click', async () => {
            try {
                const data = JSON.parse(document.getElementById('test-data').value);
                data.counter = (data.counter || 0) + 1;
                data.timestamp = new Date().toISOString();
                document.getElementById('test-data').value = JSON.stringify(data, null, 2);
                
                log(`Incremented counter to ${data.counter}`);
                await saveToGitHub(data);
            } catch (error) {
                log('ERROR: ' + error.message);
                setStatus(error.message, true);
            }
        });

        async function saveToGitHub(data) {
            log('Starting GitHub save...');
            
            if (!config.token || !config.owner || !config.repo) {
                log('ERROR: GitHub configuration incomplete');
                setStatus('GitHub configuration required', true);
                return;
            }

            try {
                log(`Saving to: ${config.owner}/${config.repo}/${config.filename}`);

                // Get current file SHA
                let sha = null;
                try {
                    log('Fetching current file SHA...');
                    const getResponse = await fetch(
                        `https://api.github.com/repos/${config.owner}/${config.repo}/contents/${config.filename}`,
                        {
                            headers: {
                                'Authorization': `token ${config.token}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        }
                    );
                    
                    log(`GET response: ${getResponse.status}`);
                    
                    if (getResponse.ok) {
                        const currentFile = await getResponse.json();
                        sha = currentFile.sha;
                        log(`Found existing file with SHA: ${sha}`);
                    } else if (getResponse.status === 404) {
                        log('File does not exist yet, will create new');
                    } else {
                        const errorData = await getResponse.json();
                        log(`GET error: ${JSON.stringify(errorData)}`);
                    }
                } catch (error) {
                    log(`GET error: ${error.message}`);
                }

                // Prepare content
                const content = JSON.stringify(data, null, 2);
                const body = {
                    message: `Test save - ${new Date().toISOString()}`,
                    content: btoa(content),
                    branch: config.branch
                };

                if (sha) {
                    body.sha = sha;
                }

                log('Sending PUT request...');
                log(`Request body: ${JSON.stringify({...body, content: '[base64 data]'})}`);

                // Save to GitHub
                const response = await fetch(
                    `https://api.github.com/repos/${config.owner}/${config.repo}/contents/${config.filename}`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${config.token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(body)
                    }
                );

                log(`PUT response: ${response.status}`);

                if (response.ok) {
                    const responseData = await response.json();
                    log(`Success! Commit SHA: ${responseData.commit.sha}`);
                    setStatus('✅ Saved to GitHub successfully');
                } else {
                    const errorData = await response.json();
                    log(`PUT error: ${JSON.stringify(errorData)}`);
                    setStatus(`Failed to save: ${errorData.message}`, true);
                }
            } catch (error) {
                log(`Exception: ${error.message}`);
                setStatus(`Error: ${error.message}`, true);
            }
        }

        async function loadFromGitHub() {
            log('Starting GitHub load...');
            
            if (!config.token || !config.owner || !config.repo) {
                log('ERROR: GitHub configuration incomplete');
                setStatus('GitHub configuration required', true);
                return;
            }

            try {
                log(`Loading from: ${config.owner}/${config.repo}/${config.filename}`);
                
                const response = await fetch(
                    `https://api.github.com/repos/${config.owner}/${config.repo}/contents/${config.filename}`,
                    {
                        headers: {
                            'Authorization': `token ${config.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );

                log(`Load response: ${response.status}`);

                if (response.ok) {
                    const data = await response.json();
                    const content = atob(data.content);
                    document.getElementById('test-data').value = content;
                    log('Successfully loaded from GitHub');
                    setStatus('✅ Loaded from GitHub');
                } else {
                    const errorData = await response.json();
                    log(`Load error: ${JSON.stringify(errorData)}`);
                    setStatus(`Failed to load: ${errorData.message}`, true);
                }
            } catch (error) {
                log(`Exception: ${error.message}`);
                setStatus(`Error: ${error.message}`, true);
            }
        }

        // Load saved config on page load
        document.addEventListener('DOMContentLoaded', () => {
            const savedConfig = localStorage.getItem('github-test-config');
            if (savedConfig) {
                config = JSON.parse(savedConfig);
                document.getElementById('token').value = config.token;
                document.getElementById('owner').value = config.owner;
                document.getElementById('repo').value = config.repo;
                document.getElementById('filename').value = config.filename;
                log('Loaded saved configuration');
            }
        });
    </script>
</body>
</html>
