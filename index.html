import React, { useState, useEffect } from 'react';
import { CheckCircle, Circle, Clock, AlertCircle, Edit2, Save, X, Settings, Download, Upload, RefreshCw } from 'lucide-react';

const GitHubProgressTracker = () => {
  const [expandedEpics, setExpandedEpics] = useState({});
  const [editingFeature, setEditingFeature] = useState(null);
  const [epics, setEpics] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showSettings, setShowSettings] = useState(false);
  const [syncing, setSyncing] = useState(false);
  const [syncStatus, setSyncStatus] = useState('');

  // GitHub configuration
  const [gitHubConfig, setGitHubConfig] = useState({
    token: '',
    owner: '',
    repo: '',
    filename: 'progress-data.json',
    branch: 'main'
  });

  // Default epic data structure
  const defaultEpics = [
    {
      id: 'epic-001',
      number: 'Enrollment-001',
      name: 'AccountCreation',
      description: 'Enable secure client onboarding and access management',
      journey: 'REGISTER',
      status: 'completed',
      notes: 'Epic v1.3 completed - Consolidated into single feature document',
      mvp1Features: [
        {
          number: 'Enrollment-001.001',
          name: 'GuidedOnboardingAccess',
          description: 'Account creation, login with unique ID, organization pre-population',
          stories: 25,
          status: 'completed',
          notes: 'Consolidated with 001.002 into single comprehensive feature document'
        }
      ],
      mvp2Features: []
    },
    {
      id: 'epic-002',
      number: 'Enrollment-002',
      name: 'AccountManagement',
      description: 'Enable clients to manage their account data and account lifecycle',
      journey: 'REGISTER',
      status: 'completed',
      notes: 'Epic v1.3 completed - Data retention updated from 7 days to 30 days',
      mvp1Features: [
        {
          number: 'Enrollment-002.001',
          name: 'DataTransparencyRetentionPurging',
          description: 'Account deletion, data retention (30 days), and purging compliance',
          stories: 15,
          status: 'completed',
          notes: 'Updated: Data retention changed from 7 days to 30 days'
        }
      ],
      mvp2Features: []
    },
    {
      id: 'epic-003',
      number: 'Enrollment-003',
      name: 'FileUploadIngestion',
      description: 'Core platform capability for securely uploading, validating, and processing files',
      journey: 'SCORE (FREE & PAID)',
      status: 'completed',
      notes: 'Epic v1.3 completed - All MVP 1 & 2 features documented',
      mvp1Features: [
        {
          number: 'Enrollment-003.001',
          name: 'FileUploadManagement',
          description: 'Secure upload with progress tracking and validation',
          stories: 16,
          status: 'completed',
          notes: 'v1.1 - PHI attestation and upload flow optimization'
        },
        {
          number: 'Enrollment-003.002',
          name: 'FileStandardization',
          description: 'AI-powered file standardization to 834 EDI format',
          stories: 23,
          status: 'completed',
          notes: 'v3.0 - Documentation Standards optimization with AI field mapping'
        },
        {
          number: 'Enrollment-003.003',
          name: 'ProgressTrackingNotification',
          description: 'Real-time progress tracking and email notifications',
          stories: 13,
          status: 'completed',
          notes: 'v1.2 - Complete progress tracking with dashboard and notifications'
        }
      ],
      mvp2Features: [
        {
          number: 'Enrollment-003.004',
          name: 'IdentifiedFileUpload',
          description: 'Identified data upload with PHI handling for Fix tier',
          stories: 11,
          status: 'completed',
          notes: 'v1.1 - Fix tier PHI file upload with enhanced security'
        }
      ]
    },
    {
      id: 'epic-004',
      number: 'Enrollment-004',
      name: 'DataQualityScoring',
      description: 'Comprehensive analysis and scoring of data quality issues',
      journey: 'SCORE (FREE & PAID)',
      status: 'completed',
      notes: 'Epic v1.2 completed - Error detection and scoring dashboard',
      mvp1Features: [
        {
          number: 'Enrollment-004.001',
          name: 'ScoringBreakdown',
          description: 'Detailed scoring dashboard with error categorization',
          stories: 20,
          status: 'completed',
          notes: 'Comprehensive dashboard with four-category error taxonomy and cost breakdown'
        },
        {
          number: 'Enrollment-004.002',
          name: 'CostCalculator',
          description: 'Business cost calculation for data quality issues',
          stories: 12,
          status: 'completed',
          notes: 'Complete cost impact analysis with industry benchmarks'
        }
      ],
      mvp2Features: []
    },
    {
      id: 'epic-005',
      number: 'Enrollment-005',
      name: 'AutomatedCorrection',
      description: 'AI-powered automatic correction of common data quality issues',
      journey: 'FIX (PAID)',
      status: 'completed',
      notes: 'Epic completed - AI correction engine foundation',
      mvp1Features: [],
      mvp2Features: [
        {
          number: 'Enrollment-005.001',
          name: 'CorrectionEngine',
          description: 'AI-powered correction generation and validation',
          stories: 15,
          status: 'completed',
          notes: 'AI correction engine with confidence scoring and validation'
        }
      ]
    },
    {
      id: 'epic-006',
      number: 'Enrollment-006',
      name: 'CorrectionReviewManagement',
      description: 'User interface for reviewing and approving AI-generated corrections',
      journey: 'FIX (PAID)',
      status: 'completed',
      notes: 'Epic completed - Complete correction review workflow with toggle interface and transparency',
      mvp1Features: [],
      mvp2Features: [
        {
          number: 'Enrollment-006.001',
          name: 'FixReviewInterface',
          description: 'Interactive interface for reviewing and selecting corrections with toggle controls',
          stories: 20,
          status: 'completed',
          notes: 'v1.1 - Complete toggle interface with "Apply fix" labels, error category chips, and record-level overrides'
        },
        {
          number: 'Enrollment-006.002',
          name: 'FixResults',
          description: 'Post-correction summary with complete error transparency and download options',
          stories: 14,
          status: 'completed',
          notes: 'v1.2 - Complete error breakdown cards, deselected records table, and dynamic metrics based on user selections'
        }
      ]
    },
    {
      id: 'epic-007',
      number: 'Enrollment-007',
      name: 'ManualReviewManagement',
      description: 'Tools for manual correction of complex data quality issues',
      journey: 'MANAGE (PAID)',
      status: 'not-started',
      notes: '',
      mvp1Features: [],
      mvp2Features: [
        {
          number: 'Enrollment-007.001',
          name: 'ManualCorrectionInterface',
          description: 'User interface for manual data correction and validation',
          stories: 16,
          status: 'not-started',
          notes: ''
        }
      ]
    },
    {
      id: 'epic-008',
      number: 'Enrollment-008',
      name: 'FileExportDelivery',
      description: 'Export and delivery of corrected files in required formats',
      journey: 'FIX & MANAGE (PAID)',
      status: 'not-started',
      notes: '',
      mvp1Features: [],
      mvp2Features: [
        {
          number: 'Enrollment-008.001',
          name: 'CorrectedFileExport',
          description: 'Export corrected 834 EDI files and error reports',
          stories: 8,
          status: 'not-started',
          notes: ''
        }
      ]
    },
    {
      id: 'epic-009',
      number: 'Enrollment-009',
      name: 'ComplianceAuditReporting',
      description: 'Comprehensive audit trails and compliance reporting',
      journey: 'ALL TIERS',
      status: 'not-started',
      notes: '',
      mvp1Features: [
        {
          number: 'Enrollment-009.001',
          name: 'AuditTrailGeneration',
          description: 'Comprehensive audit trail capture and storage',
          stories: 7,
          status: 'not-started',
          notes: ''
        }
      ],
      mvp2Features: [
        {
          number: 'Enrollment-009.002',
          name: 'ComplianceReporting',
          description: 'Automated compliance reports and regulatory submissions',
          stories: 12,
          status: 'not-started',
          notes: ''
        }
      ]
    }
  ];

  // Initialize and load data
  useEffect(() => {
    initializeData();
  }, []);

  const initializeData = async () => {
    // Load saved GitHub configuration from localStorage
    const savedConfig = localStorage.getItem('github-tracker-config');
    if (savedConfig) {
      const config = JSON.parse(savedConfig);
      setGitHubConfig(config);
      
      // Try to load data from GitHub
      await loadFromGitHub(config);
    } else {
      // No config, use default data
      setEpics(defaultEpics);
      setLoading(false);
    }
  };

  // GitHub configuration management
  const saveConfig = () => {
    localStorage.setItem('github-tracker-config', JSON.stringify(gitHubConfig));
    setSyncStatus('Configuration saved locally');
    setTimeout(() => setSyncStatus(''), 3000);
  };

  // Load data from GitHub
  const loadFromGitHub = async (config = gitHubConfig) => {
    if (!config.token || !config.owner || !config.repo) {
      setEpics(defaultEpics);
      setLoading(false);
      return;
    }

    setSyncing(true);
    try {
      const response = await fetch(
        `https://api.github.com/repos/${config.owner}/${config.repo}/contents/${config.filename}?ref=${config.branch}`,
        {
          headers: {
            'Authorization': `token ${config.token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        }
      );

      if (response.ok) {
        const data = await response.json();
        const content = JSON.parse(atob(data.content));
        setEpics(content.epics || defaultEpics);
        setSyncStatus('âœ… Loaded from GitHub');
      } else if (response.status === 404) {
        // File doesn't exist yet, use defaults and create it
        setEpics(defaultEpics);
        await saveToGitHub(defaultEpics, config);
        setSyncStatus('ðŸ“ Created new progress file on GitHub');
      } else {
        throw new Error(`GitHub API error: ${response.status}`);
      }
    } catch (error) {
      console.error('Error loading from GitHub:', error);
      setEpics(defaultEpics);
      setSyncStatus('âŒ Failed to load from GitHub');
    }
    
    setSyncing(false);
    setLoading(false);
    setTimeout(() => setSyncStatus(''), 5000);
  };

  // Save data to GitHub
  const saveToGitHub = async (epicsData = epics, config = gitHubConfig) => {
    if (!config.token || !config.owner || !config.repo) {
      setSyncStatus('âŒ GitHub configuration required');
      setTimeout(() => setSyncStatus(''), 3000);
      return;
    }

    setSyncing(true);
    try {
      // First, try to get the current file SHA (required for updates)
      let sha = null;
      try {
        const getResponse = await fetch(
          `https://api.github.com/repos/${config.owner}/${config.repo}/contents/${config.filename}`,
          {
            headers: {
              'Authorization': `token ${config.token}`,
              'Accept': 'application/vnd.github.v3+json'
            }
          }
        );
        
        if (getResponse.ok) {
          const currentFile = await getResponse.json();
          sha = currentFile.sha;
        }
      } catch (error) {
        // File might not exist yet, which is fine
      }

      // Prepare the content
      const content = {
        epics: epicsData,
        lastUpdated: new Date().toISOString(),
        version: '1.0'
      };

      const body = {
        message: `Update progress tracker - ${new Date().toISOString()}`,
        content: btoa(JSON.stringify(content, null, 2)),
        branch: config.branch
      };

      if (sha) {
        body.sha = sha;
      }

      // Save to GitHub
      const response = await fetch(
        `https://api.github.com/repos/${config.owner}/${config.repo}/contents/${config.filename}`,
        {
          method: 'PUT',
          headers: {
            'Authorization': `token ${config.token}`,
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(body)
        }
      );

      if (response.ok) {
        setSyncStatus('âœ… Saved to GitHub');
      } else {
        const errorData = await response.json();
        throw new Error(`GitHub save failed: ${errorData.message}`);
      }
    } catch (error) {
      console.error('Error saving to GitHub:', error);
      setSyncStatus('âŒ Failed to save to GitHub');
    }

    setSyncing(false);
    setTimeout(() => setSyncStatus(''), 3000);
  };

  // Calculate overall progress
  const progress = (() => {
    const allFeatures = epics.flatMap(epic => [...epic.mvp1Features, ...epic.mvp2Features]);
    const completed = allFeatures.filter(f => f.status === 'completed').length;
    const total = allFeatures.length;
    const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
    
    return { completed, total, percentage };
  })();

  // Update feature status and auto-save to GitHub
  const updateFeatureStatus = async (epicId, featureNumber, newStatus, mvpType) => {
    const updatedEpics = epics.map(epic => {
      if (epic.id === epicId) {
        const updatedEpic = { ...epic };
        updatedEpic[mvpType] = epic[mvpType].map(feature => 
          feature.number === featureNumber 
            ? { ...feature, status: newStatus }
            : feature
        );
        return updatedEpic;
      }
      return epic;
    });
    
    setEpics(updatedEpics);
    
    // Also save to localStorage as backup
    localStorage.setItem('progress-tracker-data', JSON.stringify(updatedEpics));
    
    // Auto-save to GitHub
    await saveToGitHub(updatedEpics);
  };

  // Update feature notes and auto-save to GitHub
  const updateFeatureNotes = async (epicId, featureNumber, newNotes, mvpType) => {
    const updatedEpics = epics.map(epic => {
      if (epic.id === epicId) {
        const updatedEpic = { ...epic };
        updatedEpic[mvpType] = epic[mvpType].map(feature => 
          feature.number === featureNumber 
            ? { ...feature, notes: newNotes }
            : feature
        );
        return updatedEpic;
      }
      return epic;
    });
    
    setEpics(updatedEpics);
    
    // Also save to localStorage as backup
    localStorage.setItem('progress-tracker-data', JSON.stringify(updatedEpics));
    
    // Auto-save to GitHub
    await saveToGitHub(updatedEpics);
  };

  // Export functionality
  const exportData = () => {
    const dataStr = JSON.stringify({ epics, lastUpdated: new Date().toISOString() }, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'progress-tracker-backup.json';
    link.click();
    URL.revokeObjectURL(url);
  };

  // Import functionality
  const importData = (event) => {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const imported = JSON.parse(e.target.result);
          if (imported.epics) {
            setEpics(imported.epics);
            localStorage.setItem('progress-tracker-data', JSON.stringify(imported.epics));
            await saveToGitHub(imported.epics);
            setSyncStatus('âœ… Data imported and synced');
            setTimeout(() => setSyncStatus(''), 3000);
          }
        } catch (error) {
          setSyncStatus('âŒ Invalid file format');
          setTimeout(() => setSyncStatus(''), 3000);
        }
      };
      reader.readAsText(file);
    }
    event.target.value = '';
  };

  const toggleEpicExpansion = (epicId) => {
    setExpandedEpics(prev => ({
      ...prev,
      [epicId]: !prev[epicId]
    }));
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <div className="text-center">
          <RefreshCw className="w-8 h-8 animate-spin text-blue-600 mx-auto mb-4" />
          <p className="text-gray-600">Loading progress tracker...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="max-w-6xl mx-auto p-6 bg-gray-50 min-h-screen">
      {/* Header */}
      <div className="bg-white rounded-lg shadow-sm p-6 mb-6">
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold text-gray-900">Enrollment MVP Progress Tracker</h1>
            <p className="text-gray-600 mt-2">Real-time tracking of feature development progress with GitHub sync</p>
          </div>
          <div className="flex items-center space-x-3">
            {syncStatus && (
              <div className="px-3 py-1 text-sm rounded-full bg-blue-50 text-blue-700">
                {syncStatus}
              </div>
            )}
            {syncing && (
              <RefreshCw className="w-5 h-5 animate-spin text-blue-600" />
            )}
            <button
              onClick={() => setShowSettings(!showSettings)}
              className="p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg"
              title="Settings"
            >
              <Settings className="w-5 h-5" />
            </button>
          </div>
        </div>

        {/* GitHub Settings Panel */}
        {showSettings && (
          <div className="mt-6 p-4 bg-gray-50 rounded-lg border">
            <h3 className="text-lg font-medium text-gray-900 mb-4">GitHub Configuration</h3>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Personal Access Token
                </label>
                <input
                  type="password"
                  value={gitHubConfig.token}
                  onChange={(e) => setGitHubConfig({...gitHubConfig, token: e.target.value})}
                  className="w-full p-2 border rounded text-sm"
                  placeholder="ghp_your_token_here"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Repository Owner
                </label>
                <input
                  type="text"
                  value={gitHubConfig.owner}
                  onChange={(e) => setGitHubConfig({...gitHubConfig, owner: e.target.value})}
                  className="w-full p-2 border rounded text-sm"
                  placeholder="your-username"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Repository Name
                </label>
                <input
                  type="text"
                  value={gitHubConfig.repo}
                  onChange={(e) => setGitHubConfig({...gitHubConfig, repo: e.target.value})}
                  className="w-full p-2 border rounded text-sm"
                  placeholder="enrollment-progress-tracker"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  File Name
                </label>
                <input
                  type="text"
                  value={gitHubConfig.filename}
                  onChange={(e) => setGitHubConfig({...gitHubConfig, filename: e.target.value})}
                  className="w-full p-2 border rounded text-sm"
                  placeholder="progress-data.json"
                />
              </div>
            </div>
            <div className="mt-4 flex items-center space-x-2">
              <button
                onClick={saveConfig}
                className="px-3 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700"
              >
                Save Config
              </button>
              <button
                onClick={() => loadFromGitHub()}
                disabled={syncing}
                className="px-3 py-2 bg-green-600 text-white rounded text-sm hover:bg-green-700 disabled:opacity-50"
              >
                {syncing ? 'Syncing...' : 'Load from GitHub'}
              </button>
              <button
                onClick={exportData}
                className="px-3 py-2 bg-gray-600 text-white rounded text-sm hover:bg-gray-700"
              >
                <Download className="w-4 h-4 inline mr-1" />
                Export
              </button>
              <label className="px-3 py-2 bg-gray-600 text-white rounded text-sm hover:bg-gray-700 cursor-pointer">
                <Upload className="w-4 h-4 inline mr-1" />
                Import
                <input
                  type="file"
                  accept=".json"
                  onChange={importData}
                  className="hidden"
                />
              </label>
            </div>
          </div>
        )}

        {/* Overall Progress */}
        <div className="bg-blue-50 rounded-lg p-4 mt-6">
          <div className="flex items-center justify-between mb-2">
            <span className="text-sm font-semibold text-gray-700">Overall Progress</span>
            <span className="text-sm font-semibold text-blue-700">
              {progress.completed} of {progress.total} features completed ({progress.percentage}%)
            </span>
          </div>
          <div className="w-full bg-gray-200 rounded-full h-3">
            <div 
              className="bg-blue-600 h-3 rounded-full transition-all duration-300" 
              style={{ width: `${progress.percentage}%` }}
            ></div>
          </div>
        </div>
      </div>

      {/* Epic Cards */}
      <div className="space-y-4">
        {epics.map((epic) => (
          <div key={epic.id} className="bg-white rounded-lg shadow-sm border">
            <div 
              className="p-4 cursor-pointer hover:bg-gray-50 transition-colors"
              onClick={() => toggleEpicExpansion(epic.id)}
            >
              <div className="flex items-center justify-between">
                <div className="flex items-center space-x-3">
                  <div className={`w-3 h-3 rounded-full ${
                    epic.status === 'completed' ? 'bg-green-500' :
                    epic.status === 'in-progress' ? 'bg-blue-500' : 'bg-gray-400'
                  }`}></div>
                  <div>
                    <h3 className="text-lg font-semibold text-gray-900">
                      {epic.number} - {epic.name}
                    </h3>
                    <p className="text-gray-600 text-sm">{epic.description}</p>
                    <div className="flex items-center space-x-4 mt-1">
                      <span className="text-xs text-blue-600 font-medium">{epic.journey}</span>
                      <span className={`text-xs px-2 py-1 rounded-full ${
                        epic.status === 'completed' ? 'bg-green-100 text-green-800' :
                        epic.status === 'in-progress' ? 'bg-blue-100 text-blue-800' :
                        'bg-gray-100 text-gray-800'
                      }`}>
                        {epic.status.replace('-', ' ')}
                      </span>
                    </div>
                  </div>
                </div>
                <div className="text-right">
                  <div className="text-sm text-gray-500">
                    MVP1: {epic.mvp1Features.length} â€¢ MVP2: {epic.mvp2Features.length}
                  </div>
                  <div className="text-xs text-gray-400 mt-1">
                    {expandedEpics[epic.id] ? 'â–¼' : 'â–¶'} Click to expand
                  </div>
                </div>
              </div>
              
              {epic.notes && (
                <div className="mt-2 text-sm text-blue-600 italic">
                  {epic.notes}
                </div>
              )}
            </div>

            {expandedEpics[epic.id] && (
              <div className="px-4 pb-4 border-t border-gray-100">
                {epic.mvp1Features.length > 0 && (
                  <div className="mb-4">
                    <h4 className="font-medium text-gray-900 mb-2 mt-3">MVP 1 Features</h4>
                    <div className="space-y-2">
                      {epic.mvp1Features.map((feature, index) => (
                        <FeatureCard 
                          key={index}
                          feature={feature}
                          epicId={epic.id}
                          mvpType="mvp1Features"
                          onStatusUpdate={updateFeatureStatus}
                          onNotesUpdate={updateFeatureNotes}
                          editingFeature={editingFeature}
                          setEditingFeature={setEditingFeature}
                        />
                      ))}
                    </div>
                  </div>
                )}

                {epic.mvp2Features.length > 0 && (
                  <div>
                    <h4 className="font-medium text-gray-900 mb-2">MVP 2 Features</h4>
                    <div className="space-y-2">
                      {epic.mvp2Features.map((feature, index) => (
                        <FeatureCard 
                          key={index}
                          feature={feature}
                          epicId={epic.id}
                          mvpType="mvp2Features"
                          onStatusUpdate={updateFeatureStatus}
                          onNotesUpdate={updateFeatureNotes}
                          editingFeature={editingFeature}
                          setEditingFeature={setEditingFeature}
                        />
                      ))}
                    </div>
                  </div>
                )}
              </div>
            )}
          </div>
        ))}
      </div>

      {/* Summary Statistics */}
      <div className="mt-6 bg-white rounded-lg shadow-sm p-6">
        <h2 className="text-xl font-semibold text-gray-900 mb-4">Summary</h2>
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div className="bg-gray-50 rounded-lg p-4">
            <div className="text-2xl font-bold text-gray-900">9</div>
            <div className="text-sm text-gray-600">Total Epics</div>
          </div>
          <div className="bg-green-50 rounded-lg p-4">
            <div className="text-2xl font-bold text-green-700">
              {epics.flatMap(e => e.mvp1Features).length}
            </div>
            <div className="text-sm text-gray-600">MVP 1 Features</div>
          </div>
          <div className="bg-blue-50 rounded-lg p-4">
            <div className="text-2xl font-bold text-blue-700">
              {epics.flatMap(e => e.mvp2Features).length}
            </div>
            <div className="text-sm text-gray-600">MVP 2 Features</div>
          </div>
          <div className="bg-purple-50 rounded-lg p-4">
            <div className="text-2xl font-bold text-purple-700">
              {epics.flatMap(e => [...e.mvp1Features, ...e.mvp2Features]).length}
            </div>
            <div className="text-sm text-gray-600">Total Features</div>
          </div>
        </div>
        
        <div className="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
          <div className="bg-green-50 rounded-lg p-4">
            <div className="text-2xl font-bold text-green-700">
              {epics.filter(e => e.status === 'completed').length}
            </div>
            <div className="text-sm text-gray-600">Epics Completed</div>
          </div>
          <div className="bg-blue-50 rounded-lg p-4">
            <div className="text-2xl font-bold text-blue-700">{progress.completed}</div>
            <div className="text-sm text-gray-600">Features Completed</div>
          </div>
          <div className="bg-purple-50 rounded-lg p-4">
            <div className="text-2xl font-bold text-purple-700">
              {epics.flatMap(e => [...e.mvp1Features, ...e.mvp2Features])
                .filter(f => f.status === 'completed')
                .reduce((sum, f) => sum + f.stories, 0)}
            </div>
            <div className="text-sm text-gray-600">Total Stories (Completed)</div>
          </div>
        </div>
      </div>

      {/* Footer */}
      <div className="mt-6 text-center text-sm text-gray-500">
        <p>Last Updated: {new Date().toLocaleDateString()}</p>
        <p className="mt-1">Document Status: Live GitHub-Synced Tracker</p>
        <p className="mt-1">ðŸ’¾ All changes automatically saved to GitHub</p>
      </div>
    </div>
  );
};

// Feature Card Component with inline editing
const FeatureCard = ({ 
  feature, 
  epicId, 
  mvpType, 
  onStatusUpdate, 
  onNotesUpdate, 
  editingFeature, 
  setEditingFeature 
}) => {
  const [tempNotes, setTempNotes] = useState(feature.notes);
  
  const getStatusIcon = (status) => {
    switch(status) {
      case 'completed':
        return <CheckCircle className="w-5 h-5 text-green-600" />;
      case 'in-progress':
        return <Clock className="w-5 h-5 text-blue-600" />;
      case 'not-started':
        return <Circle className="w-5 h-5 text-gray-400" />;
      default:
        return <AlertCircle className="w-5 h-5 text-yellow-600" />;
    }
  };

  const getStatusColor = (status) => {
    const colors = {
      'completed': 'bg-green-100 text-green-800',
      'in-progress': 'bg-blue-100 text-blue-800',
      'not-started': 'bg-gray-100 text-gray-800'
    };
    return colors[status] || 'bg-gray-100 text-gray-800';
  };

  const handleStatusClick = (e) => {
    e.stopPropagation();
    const statuses = ['not-started', 'in-progress', 'completed'];
    const currentIndex = statuses.indexOf(feature.status);
    const nextStatus = statuses[(currentIndex + 1) % statuses.length];
    onStatusUpdate(epicId, feature.number, nextStatus, mvpType);
  };

  const handleEditNotes = (e) => {
    e.stopPropagation();
    setEditingFeature(feature.number);
    setTempNotes(feature.notes);
  };

  const handleSaveNotes = (e) => {
    e.stopPropagation();
    onNotesUpdate(epicId, feature.number, tempNotes, mvpType);
    setEditingFeature(null);
  };

  const handleCancelEdit = (e) => {
    e.stopPropagation();
    setTempNotes(feature.notes);
    setEditingFeature(null);
  };

  const isEditing = editingFeature === feature.number;

  return (
    <div className="bg-white rounded border p-3">
      <div className="flex items-start justify-between">
        <div className="flex items-start space-x-2">
          {getStatusIcon(feature.status)}
          <div className="flex-1">
            <div className="flex items-center space-x-2">
              <h5 className="font-medium text-gray-900">{feature.number}</h5>
              <button
                onClick={handleStatusClick}
                className={`px-2 py-1 rounded-full text-xs font-medium transition-colors hover:opacity-80 ${getStatusColor(feature.status)}`}
              >
                {feature.status.replace('-', ' ')}
              </button>
            </div>
            <p className="text-sm text-gray-600">{feature.name}</p>
            <p className="text-xs text-gray-500 mt-1">{feature.description}</p>
          </div>
        </div>
        <div className="text-right text-xs text-gray-500">
          <span>Stories: {feature.stories}</span>
        </div>
      </div>
      
      {/* Notes Section */}
      <div className="mt-2">
        {isEditing ? (
          <div className="flex items-start space-x-2">
            <textarea
              value={tempNotes}
              onChange={(e) => setTempNotes(e.target.value)}
              onClick={(e) => e.stopPropagation()}
              className="flex-1 text-xs p-2 border rounded resize-none"
              rows="2"
              placeholder="Add notes..."
            />
            <div className="flex flex-col space-y-1">
              <button
                onClick={handleSaveNotes}
                className="p-1 text-green-600 hover:bg-green-50 rounded"
                title="Save"
              >
                <Save className="w-3 h-3" />
              </button>
              <button
                onClick={handleCancelEdit}
                className="p-1 text-gray-600 hover:bg-gray-50 rounded"
                title="Cancel"
              >
                <X className="w-3 h-3" />
              </button>
            </div>
          </div>
        ) : (
          <div className="flex items-start justify-between">
            {feature.notes ? (
              <p className="text-xs text-blue-600 italic flex-1">{feature.notes}</p>
            ) : (
              <p className="text-xs text-gray-400 italic flex-1">No notes</p>
            )}
            <button
              onClick={handleEditNotes}
              className="ml-2 p-1 text-gray-400 hover:text-gray-600 hover:bg-gray-50 rounded"
              title="Edit notes"
            >
              <Edit2 className="w-3 h-3" />
            </button>
          </div>
        )}
      </div>
    </div>
  );
};

export default GitHubProgressTracker;
